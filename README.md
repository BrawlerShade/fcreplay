<!--ts-->
   * [About](#about)
   * [Goal](#goal)
      * [How it works](#how-it-works)
      * [Character Detection](#character-detection)
         * [A few more notes:](#a-few-more-notes)
      * [Todo](#todo)
      * [Requirements](#requirements)
         * [Uploading to archive.org](#uploading-to-archiveorg)
   * [Installation and setup](#installation-and-setup)
      * [Configuration](#configuration)
      * [(Optional) Google cloud](#optional-google-cloud)
         * [Infrastructure Deployment](#infrastructure-deployment)
         * [Configure base image](#configure-base-image)
      * [Deployment](#deployment)
      * [Post Deployment Setup](#post-deployment-setup)
   * [Usage](#usage)
      * [Activating](#activating)
      * [Getting replays](#getting-replays)
      * [Recording a replay](#recording-a-replay)
      * [Running automatically on startup](#running-automatically-on-startup)

<!-- Added by: gino, at: Thu 30 Jul 2020 12:39:56 PM NZST -->

<!--te-->

# About
This project will upload encoded [fightcade](https://www.fightcade.com/) replays to archive.org: [Gino Lisignoli - Archive.org](https://archive.org/search.php?query=creator%3A%22Gino+Lisignoli%22)

A site the view the replays is here: https://fightcadevids.com

# Goal
The goal of this is to make fightcade replays accessible to anyone to watch without the need of using an emulator.

## How it works
fcreplaygetreplay will parse fightcade replay urls, then use the fightcade api details to create a encoding job and store it in a database.

fcreplayloop can then be used to record a replay:
1. Fightcade is started with wine
2. OBS is started to record the match
3. Match is finished
4. OBS is killed the python script takes over again.

The script then:
 1. Renames the file to the fightcade id
 2. Runs ffmpeg to correct it since killing OBS might break the file
 3. Runs ffmpeg again to generate a thumbnail
 4. Tries to determine which characters players are using OpenCV
 5. Uploads the file to archive.org with the relevant metadata
 6. Uploads the file to youtube.com with the relevant metadata 
 7. Removes the generated files.

## Character Detection
OpenCV is used to analise the video and match character names from the health bars. It does this by template matching the included character name images against the video every 60 frames. Depending on your OBS recording settings you might need to regenerate the images.

Currently this is only supported for 3rd strike.

### A few more notes:
To trigger OBS the screen is captured, looking for a the split windows and then checking for differences in the screen capture. Without memory inspection it doesn't seem like there is a way to tell when the emulator has started playing the replay.

Because fightcade doesn't have the ability to record to a video file you need to use some sort of capture software.

For this project [Open Broadcaster Software](https://obsproject.com/) is used to encode the video.

The i3 window manager is used to ensure that the ggpofba-ng window is always in the same place, and have preconfigured OBS to record that area.

This is all done in a headless X11 session

## Todo
 - Better exception handling.
 - Better capturing of OBS and Wine output.
 - Support for games other than 3rd strike.
 - Find something that might be more lightweight than OBS.
   - ffmpeg with x11 capturing was attempted, but the framerate was unacceptible
 - Thumbnails are generated but not used

## Requirements
To run this, you need:
 1. A VM or physical machine.
     1. With at least 4 Cores (Fast ones would be ideal)
     1. With at least 2GB Ram
     1. With at least 20GB of storage (Though you probably won't use that much)
 1. Running Fedora 32 (you can probably make this work in other distributions as well)
     1. You really want to use a minimal installation
 1. Some familiarity with linux will help

### Uploading to archive.org
To upload files to archive.org, set the configuration key `upload_to_ia` to `true` and configure the ia section in the configuration file. You will also need to have your `.ia` secrets file in your users home directory. This can be generated by running `ia configure` from the command line once you have setup the python virtual environment.

# Installation and setup
## Configuration
The defaults should work if you follow the guide below.

If you are using the ansible playbook, you will also want to have ready the following files:
 - Configuration file: `config.json`
 - Appened description: `description_append.txt`
 - Google cloud storage credentials: `.stroage_creds.json`
 - Google api client secrets: `.client_secrets.json`
 - Youtube upload credentials: `.youtube-upload-credentials.json`
 - Archive.org secrets: `.ia`

## (Optional) Google cloud
A terraform script for google cloud is included

### Infrastructure Deployment
To deploy to google cloud you need to:

1. Create a project
2. Create a fedora32 image
   1. This was done by following: https://linuxhint.com/install-fedora-google-compute-engine
3. Download the project api key as `~/.fcrecorder-api-credentials.json`
4. Have gcloud command line installed and your project/region set
5. Run the terraform script
6. Disable the google cloud scheduled job

### Configure base image
1. After running the terraform script ssh onto the fcrecorder machine. This is the image recording instances are provisioned from
   1. Confirm that the root partition has actually resized, mine didn't

## Deployment
I've include a basic ansible playbook for the installation, you will need to have ssh access and a deployment user with root access.

2. Use the ansible script to setup the image.
   1. Create a deployment user with with sudo access: `adduser deployment`
   2. Set a password `passwd deployment`
   3. Add the user to the wheel group: `groupmems -a deployment -g wheel`
   4. Copy your ssh key with `ssh-copy-id deployment@<host>`
   5. Disable password login in the `/etc/ssh/sshd_config` and restart sshd: `systemctl restart sshd`
   6. `ansible-playbook -i <host>, -u <deployment_user> -K --diff --extra-vars '{"gcloud": True}' playbook.yml`
 
## Post Deployment Setup
Login and switch to the fcrecorder user, then create a x11vnc password as the fcrecorder user (It will be stored in ~/.vnc/passwd):
```commandline
x11vnc -storepasswd 
```

Now you need to start the dummy X server, configure fightcade and configure OBS.
As the fcrecorder user:
```commandline
# Run tmux, and split so you have two panes
# In the first pane, run startx
startx
# In the second pane, run x11vnc
x11vnc --rfbauth ~/.vnc/passwd -noxfixes -noxdamage -noxrecord
```

Start the pulseaudio server
```commandline
pulseaudio --start
```

Check that it's working by run pavucontrol
```commandline
pavuconrol
```

In the i3 session, run ggpofba-ng:
```commandline
cd ~/fcreplay/pyqtggpo-master
wine ggpofba-ng.exe
```

And configure it with:
 1. Select blitter: Enhanced.
 1. Blitter options, mark these:
     1. Enable Pre-scale
     1. Pre-scale using SoftFX
     1. RGB effects
     1. Advanced settings: Force 16-bit emulation & Use DirectX texture management
 1. Stretch: Correct aspect ratio

Close ggpofba, and run OBS:
```commandline
obs
```

Configure OBS for your systems performance. You want to change the video output directory to `~/fcreplay/videos` with a static filename (set in the advanced section) as `replay`. Make sure to disable recording of the mouse cursor as well

Now you need to configure the scene. I found the best way to do this was to have ggpofba running, then switch OBS to a i3 floating window (win+shift+space).

 * I'm using a canvas resolution of 512x384 and a output resolutuon of 512.384.
 * For the screen capture I'm using the following crop/pad filter settings:
   * Left: 514
   * Top: 204
   * Right: 2
   * Bottom: 184

# Usage

## Activating
Before runninf fcreplay, you need to activate the python environment
```commandline
cd ~/fcreplay
source ./venv/bin/activate
```

## Getting replays
This will download a replay, and place it in the database
```commandline
fcreplayget <fightcade profile> <replay url>
```


## Recording a replay
Within a Xorg session:
```commandline
fcreplayloop
```
You can also run `fcreplayloop --debug` to only run for a single iteration. Useful for testing.

## Running automatically on startup
To run fcreplay automatically on startup you need to enable the service, and uncommet the i3 line:
```commandline
systemctl enable fcrecord
sed -i 's/^# exec "xterm/exec "xterm/' .config/i3/config
```
